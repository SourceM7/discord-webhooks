name: Send Random Quran Verse

on:
  schedule:
    - cron: '0 * * * *'        # every hour
  workflow_dispatch:

env:
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

jobs:
  send-verse:
    runs-on: ubuntu-latest

    steps:
      - name: Install ImageMagick & jq
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick jq

      - name: Fetch verse, build embed and send
        shell: bash
        run: |
          set -euo pipefail

          # --------------------------------------------------------
          # 1. Fetch data (Arabic, tafseer, English)
          # --------------------------------------------------------
          verse_number=$(( RANDOM % 6236 + 1 ))

          verse_json=$(curl -s "https://api.alquran.cloud/v1/ayah/${verse_number}/ar.alafasy")
          tafseer_json=$(curl -s "https://api.alquran.cloud/v1/ayah/${verse_number}/ar.muyassar")
          english_json=$(curl -s "https://api.alquran.cloud/v1/ayah/${verse_number}/en.asad")

          verse_text=$(echo "$verse_json"    | jq -r '.data.text')
          surah_name_ar=$(echo "$verse_json" | jq -r '.data.surah.name')
          surah_number=$(echo "$verse_json"  | jq -r '.data.surah.number')
          ayah_in_surah=$(echo "$verse_json" | jq -r '.data.numberInSurah')
          audio_url=$(echo "$verse_json"     | jq -r '.data.audio')

          tafseer_text=$(echo "$tafseer_json" | jq -r '.data.text')
          english_text=$(echo "$english_json" | jq -r '.data.text')
          surah_name_en=$(echo "$english_json"| jq -r '.data.surah.englishName')

          # --------------------------------------------------------
          # 2. Prepare ayah image (white background)
          # --------------------------------------------------------
          img_url="https://cdn.islamic.network/quran/images/high-resolution/${surah_number}_${ayah_in_surah}.png"
          img_raw="ayah_${surah_number}_${ayah_in_surah}.png"
          img_white="ayah_${surah_number}_${ayah_in_surah}_white.png"

          curl -s -o "$img_raw" "$img_url"
          convert "$img_raw" -background white -alpha remove -alpha off "$img_white"

          # --------------------------------------------------------
          # 3. Download audio
          # --------------------------------------------------------
          safe_surah=$(echo "$surah_name_ar" | tr ' ' _)
          audio_file="${safe_surah}_${ayah_in_surah}.mp3"
          curl -s -o "$audio_file" "$audio_url"

          # --------------------------------------------------------
          # 4. Build embed JSON (Arabic + tafseer + English)
          # --------------------------------------------------------
          jq -n \
            --arg verse   "$verse_text" \
            --arg tafseer "$tafseer_text" \
            --arg eng     "$english_text" \
            --arg surahA  "$surah_name_ar" \
            --arg surahE  "$surah_name_en" \
            --arg ayahN   "$ayah_in_surah" \
            '{
              embeds: [
                {
                  description:
                    ("﴿ **" + $verse + "** ﴾\n\n" +
                     "**التفسير الميسر**\n" + $tafseer + "\n\n" +
                     "**English Translation**\n" + $eng),
                  color: 36864,
                  footer: {
                    text: ($surahA + "، الآية " + $ayahN +
                           " | " + $surahE + ", Verse " + $ayahN)
                  }
                }
              ]
            }' > payload.json     # <<―― write to file

          # --------------------------------------------------------
          # 5. Send multipart request (JSON as file)
          # --------------------------------------------------------
          curl --fail -X POST "$DISCORD_WEBHOOK_URL" \
               -F "payload_json=@payload.json;type=application/json" \
               -F "file1=@${audio_file}" \
               -F "file2=@${img_white}"

          # --------------------------------------------------------
          # 6. Clean up
          # --------------------------------------------------------
          rm -f "$img_raw" "$img_white" "$audio_file" payload.json
