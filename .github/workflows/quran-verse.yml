name: Send Random Quran Verse

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

env:
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

jobs:
  send-verse:
    runs-on: ubuntu-latest
    
    steps:
      - name: Fetch verse and send to Discord
        run: |
          # Step 1: Fetch data from the APIs
          verse_number=$((RANDOM % 6236 + 1))
          verse_response=$(curl -s "https://api.alquran.cloud/v1/ayah/${verse_number}/ar.alafasy")
          tafseer_response=$(curl -s "https://api.alquran.cloud/v1/ayah/${verse_number}/ar.muyassar")
          
          # Step 2: Extract data into shell variables using jq
          verse_text=$(echo "$verse_response" | jq -r '.data.text')
          surah_name_arabic=$(echo "$verse_response" | jq -r '.data.surah.name')
          verse_num=$(echo "$verse_response" | jq -r '.data.numberInSurah')
          surah_num=$(echo "$verse_response" | jq -r '.data.surah.number')
          audio_url=$(echo "$verse_response" | jq -r '.data.audio')
          tafseer_text=$(echo "$tafseer_response" | jq -r '.data.text')
          
          # Build verse image URL
          verse_image_url="https://cdn.islamic.network/quran/images/high-resolution/${surah_num}_${verse_num}.png"
          
          # Step 3: Download audio file with descriptive name
          # Create filename with surah and verse info
          audio_filename="${surah_name_arabic}_${verse_num}.mp3"
          curl -s -o "$audio_filename" "$audio_url"
          
          # Step 4: Build JSON payload for multipart request
          json_payload=$(jq -n \
            --arg verse "$verse_text" \
            --arg tafseer "$tafseer_text" \
            --arg surah "$surah_name_arabic" \
            --arg ayah_num "$verse_num" \
            --arg image_url "$verse_image_url" \
            '{
              "embeds": [{
                "description": ("﴿ **" + $verse + "** ﴾\n\n**التفسير الميسر**\n" + $tafseer),
                "color": 36864,
                "image": {
                  "url": $image_url
                },
                "footer": {
                  "text": ($surah + "، الآية " + $ayah_num)
                }
              }]
            }')
          
          # Step 5: Send with audio file attachment using multipart/form-data
          curl --fail \
               -F "payload_json=$json_payload" \
               -F "file=@$audio_filename" \
               "$DISCORD_WEBHOOK_URL"
          
          # Step 6: Cleanup
          rm -f "$audio_filename"
