name: Fetch verse, build embed and send
shell: bash
run: |
  set -euo pipefail

  # Get a random surah number (1 to 114)
  surah_number=$(( RANDOM % 114 + 1 ))

  # Fetch the entire surah in Arabic, English, and with Tafseer
  arabic_surah_json=$(curl -s "http://api.alquran.cloud/v1/surah/${surah_number}/ar.alafasy")
  tafseer_surah_json=$(curl -s "http://api.alquran.cloud/v1/surah/${surah_number}/ar.muyassar")
  english_surah_json=$(curl -s "http://api.alquran.cloud/v1/surah/${surah_number}/en.asad")

  # Get Surah details from the first verse's data
  surah_name_ar=$(echo "$arabic_surah_json" | jq -r '.data.name')
  surah_name_en=$(echo "$english_surah_json" | jq -r '.data.englishName')
  number_of_ayahs=$(echo "$arabic_surah_json" | jq -r '.data.numberOfAyahs')

  # Loop through each ayah of the surah
  for (( i=0; i<$number_of_ayahs; i++ ))
  do
    verse_text=$(echo "$arabic_surah_json" | jq -r ".data.ayahs[$i].text")
    ayah_in_surah=$(echo "$arabic_surah_json" | jq -r ".data.ayahs[$i].numberInSurah")
    audio_url=$(echo "$arabic_surah_json" | jq -r ".data.ayahs[$i].audio")

    tafseer_text=$(echo "$tafseer_surah_json" | jq -r ".data.ayahs[$i].text")
    english_text=$(echo "$english_surah_json" | jq -r ".data.ayahs[$i].text")

    english_tafseer_json=$(curl -s "https://cdn.jsdelivr.net/gh/spa5k/tafsir_api@main/tafsir/en-al-jalalayn/${surah_number}/${ayah_in_surah}.json")
    english_tafseer_text=$(echo "$english_tafseer_json" | jq -r '.text // "No English commentary available"')

    img_url="https://cdn.islamic.network/quran/images/high-resolution/${surah_number}_${ayah_in_surah}.png"
    img_raw="ayah${surah_number}_${ayah_in_surah}.png"
    img_white="ayah${surah_number}_${ayah_in_surah}_white.png"

    curl -s -o "$img_raw" "$img_url"
    convert "$img_raw" -background white -alpha remove -alpha off "$img_white"

    safe_surah=$(echo "$surah_name_ar" | tr ' ' '_')
    audio_file="${safe_surah}_${ayah_in_surah}.mp3"
    curl -s -o "$audio_file" "$audio_url"

    arabic_payload=$(jq -n \
      --arg verse   "$verse_text" \
      --arg tafseer "$tafseer_text" \
      --arg surahA  "$surah_name_ar" \
      --arg ayahN   "$ayah_in_surah" \
      '{
        embeds: [
          {
            description: ("﴿ " + $verse + " ﴾\n\nالتفسير الميسر\n" + $tafseer),
            color: 36864,
            footer: {
              text: ($surahA + "، الآية " + $ayahN)
            }
          }
        ]
      }')

    curl --fail -X POST "$DISCORD_WEBHOOK_URL" \
         -F "payload_json=$arabic_payload" \
         -F "file1=@${audio_file}" \
         -F "file2=@${img_white}"

    english_payload=$(jq -n \
      --arg eng     "$english_text" \
      --arg eng_tafseer "$english_tafseer_text" \
      --arg surahE  "$surah_name_en" \
      --arg ayahN   "$ayah_in_surah" \
      '{
        embeds: [
          {
            description: ($eng + "\n\nCommentary (Al-Jalalayn)\n" + $eng_tafseer),
            color: 36864,
            footer: {
              text: ($surahE + ", Verse " + $ayahN)
            }
          }
        ]
      }')

    curl --fail -X POST "$DISCORD_WEBHOOK_URL" \
         -H "Content-Type: application/json" \
         -d "$english_payload"

    rm -f "$img_raw" "$img_white" "$audio_file"
  done
