name: Send Random Quran Verse

on:
  schedule:
    - cron: '0 * * * *'       # every hour
  workflow_dispatch:

env:
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

jobs:
  send-verse:
    runs-on: ubuntu-latest

    steps:
      - name: Install ImageMagick & jq
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick jq

      - name: Fetch verse and send to Discord
        shell: bash
        run: |
          set -euo pipefail

          # --------------------------------------------------------
          # 1. Fetch data (Arabic, tafseer, English)
          # --------------------------------------------------------
          verse_number=$((RANDOM % 6236 + 1))

          verse_response=$(curl -s "https://api.alquran.cloud/v1/ayah/${verse_number}/ar.alafasy")
          tafseer_response=$(curl -s "https://api.alquran.cloud/v1/ayah/${verse_number}/ar.muyassar")
          english_response=$(curl -s "https://api.alquran.cloud/v1/ayah/${verse_number}/en.asad")

          verse_text=$(echo "$verse_response"    | jq -r '.data.text')
          surah_name_ar=$(echo "$verse_response" | jq -r '.data.surah.name')
          verse_num=$(echo "$verse_response"     | jq -r '.data.numberInSurah')
          surah_num=$(echo "$verse_response"     | jq -r '.data.surah.number')
          audio_url=$(echo "$verse_response"     | jq -r '.data.audio')

          tafseer_text=$(echo "$tafseer_response" | jq -r '.data.text')
          english_text=$(echo "$english_response" | jq -r '.data.text')
          surah_name_en=$(echo "$english_response"| jq -r '.data.surah.englishName')

          # --------------------------------------------------------
          # 2. Prepare image (white background)
          # --------------------------------------------------------
          verse_image_url="https://cdn.islamic.network/quran/images/high-resolution/${surah_num}_${verse_num}.png"
          verse_image_file="verse_${surah_num}_${verse_num}.png"
          verse_image_white_bg="verse_${surah_num}_${verse_num}_white.png"

          curl -s -o "$verse_image_file" "$verse_image_url"
          convert "$verse_image_file" -background white -alpha remove -alpha off "$verse_image_white_bg"

          # --------------------------------------------------------
          # 3. Download audio
          # --------------------------------------------------------
          safe_surah_name=$(echo "$surah_name_ar" | tr ' ' _)
          audio_filename="${safe_surah_name}_${verse_num}.mp3"
          curl -s -o "$audio_filename" "$audio_url"

          # --------------------------------------------------------
          # 4. Build embed JSON  (Arabic + tafseer + EN)
          # --------------------------------------------------------
          json_payload=$(jq -nc \
            --arg verse    "$verse_text" \
            --arg tafseer  "$tafseer_text" \
            --arg english  "$english_text" \
            --arg surahA   "$surah_name_ar" \
            --arg surahE   "$surah_name_en" \
            --arg ayahNum  "$verse_num" \
            '{
              embeds: [
                {
                  description:
                    ("﴿ **" + $verse + "** ﴾\n\n" +
                     "**التفسير الميسر**\n" + $tafseer + "\n\n" +
                     "**English Translation**\n" + $english),
                  color: 36864,
                  footer: {
                    text: ($surahA + "، الآية " + $ayahNum +
                           " | " + $surahE + ", Verse " + $ayahNum)
                  }
                }
              ]
            }')

          # --------------------------------------------------------
          # 5. Send to Discord (multipart with files)
          # --------------------------------------------------------
          curl --fail \
            -F "payload_json=${json_payload}" \
            -F "file1=@${audio_filename}" \
            -F "file2=@${verse_image_white_bg}" \
            "$DISCORD_WEBHOOK_URL"

          # --------------------------------------------------------
          # 6. Cleanup
          # --------------------------------------------------------
          rm -f "$audio_filename" "$verse_image_file" "$verse_image_white_bg"
